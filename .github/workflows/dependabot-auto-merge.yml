name: Dependabot Auto-Merge

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
    pull_request_target:
        types: [opened, synchronize, reopened, ready_for_review]

permissions:
    contents: write
    pull-requests: write

concurrency:
    group: dependabot-auto-merge-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    enable-auto-merge:
        runs-on: ubuntu-22.04
        timeout-minutes: 5
        steps:
            - name: No-op for non-Dependabot PRs
                if: github.actor != 'dependabot[bot]'
                run: echo "Non-Dependabot PR; auto-merge not applicable."

            - name: Fetch metadata
                id: meta
                if: github.actor == 'dependabot[bot]'
                uses: dependabot/fetch-metadata@v2.4.0
                with:
                    github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Enable auto-merge
                if: github.actor == 'dependabot[bot]' && (steps.meta.outputs.update-type == 'version-update:semver-minor' || steps.meta.outputs.update-type == 'version-update:semver-patch')
                uses: peter-evans/enable-pull-request-automerge@v3.0.0
                with:
                    token: ${{ secrets.GITHUB_TOKEN }}
                    pull-request-number: ${{ github.event.pull_request.number }}
                    merge-method: merge

    auto-merge:
        runs-on: ubuntu-22.04
        timeout-minutes: 5
        steps:
            - name: No-op for non-Dependabot PRs
                if: github.actor != 'dependabot[bot]'
                run: echo "Non-Dependabot PR; auto-merge not applicable."

            - name: Fetch metadata
                id: meta
                if: github.actor == 'dependabot[bot]'
                uses: dependabot/fetch-metadata@v2.4.0
                with:
                    github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Enable auto-merge
                if: github.actor == 'dependabot[bot]' && (steps.meta.outputs.update-type == 'version-update:semver-minor' || steps.meta.outputs.update-type == 'version-update:semver-patch')
                uses: peter-evans/enable-pull-request-automerge@v3.0.0
                with:
                    token: ${{ secrets.GITHUB_TOKEN }}
                    pull-request-number: ${{ github.event.pull_request.number }}
                    merge-method: merge
